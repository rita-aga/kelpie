# Task: DST Phase 2.6 - Production Code Runtime Integration

**Created:** 2026-01-19
**State:** üöß IN PROGRESS (17% - Phase 2.6.1 complete)
**Priority:** HIGH - Complete Phase 2 runtime determinism
**Plan Number:** 025
**Parent Plan:** 024_20260119_dst_phase2_runtime_determinism.md
**Depends On:** Phase 2.1-2.5 - COMPLETE

## Problem Statement

kelpie-dst tests are fully deterministic (‚úÖ), but production code in kelpie-runtime and kelpie-server still uses `tokio::spawn` and `tokio::time::sleep` directly, making kelpie-server tests non-deterministic.

**Evidence:**
```bash
# Direct tokio usage in production code
grep -rn "tokio::spawn\|tokio::time::sleep" crates/kelpie-runtime/src --include="*.rs" | wc -l
# Output: 10 usages

grep -rn "tokio::spawn\|tokio::time::sleep" crates/kelpie-server/src --include="*.rs" | wc -l
# Output: 12 usages
```

**Impact:**
- kelpie-server tests using Dispatcher spawn non-deterministic tokio tasks
- Tests with delays use real wall-clock time
- Same seed ‚â† same execution order in integration tests

## Solution: Thread Runtime Parameter Through Production Code

Make Runtime an explicit generic parameter throughout the stack:

```
Production (tokio):          Testing (madsim):
Dispatcher<A, S, TokioRuntime> ‚Üê‚Üí Dispatcher<A, S, MadsimRuntime>
                ‚Üì                                  ‚Üì
          spawns via                        spawns via
        TokioRuntime                      MadsimRuntime
```

## Architecture Decision

### Decision: Generic Parameter (Option A)

```rust
// Before
pub struct Dispatcher<A, S> { ... }

// After
pub struct Dispatcher<A, S, R: Runtime> {
    runtime: R,
    // ...
}
```

**Rationale:**
- Runtime trait is NOT dyn-safe (spawn has generic parameter)
- Generic parameter is most type-safe and explicit
- Zero runtime overhead (monomorphization)
- Caller controls which runtime to use

**Trade-off:** Breaking change requiring updates to all Dispatcher usage sites

### Alternatives Considered

**Option B: Trait Object `Arc<dyn Runtime>`**
- ‚ùå Runtime is not dyn-safe due to spawn<F> generic parameter

**Option C: Conditional Compilation**
```rust
#[cfg(not(madsim))]
use kelpie_core::TokioRuntime;
#[cfg(madsim)]
use kelpie_core::MadsimRuntime;
```
- ‚úÖ No breaking changes
- ‚ùå Less explicit, cfg everywhere
- ‚ùå Can't test both runtimes in same binary

## Implementation Phases

### Phase 2.6.1: Refactor kelpie-runtime ‚úÖ COMPLETE

**Goal:** Make Dispatcher generic over Runtime

**Changes:**
1. Add Runtime generic parameter to Dispatcher ‚úÖ
2. Replace all `tokio::spawn` with `self.runtime.spawn()` ‚úÖ
3. Replace all `tokio::time::sleep` with `self.runtime.sleep()` ‚úÖ
4. Update DispatcherHandle to propagate Runtime ‚úÖ
5. Update all tests to pass TokioRuntime ‚úÖ

**Files modified:**
- `crates/kelpie-runtime/src/dispatcher.rs` ‚úÖ (Dispatcher, DispatcherHandle, 3 tests)
- `crates/kelpie-runtime/src/handle.rs` ‚úÖ (ActorHandle, ActorHandleBuilder, 4 tests)
- `crates/kelpie-runtime/src/runtime.rs` ‚úÖ (Runtime, RuntimeBuilder, 3 tests)

**Implementation Details:**
- Made Dispatcher generic: `Dispatcher<A, S, R: Runtime + 'static>`
- Made DispatcherHandle generic: `DispatcherHandle<R: Runtime>`
- Made ActorHandle/ActorHandleBuilder generic over R
- Made Runtime/RuntimeBuilder generic over R
- Changed task field type from `JoinHandle<()>` to `Pin<Box<dyn Future<Output = Result<(), JoinError>> + Send>>`
- Added `use kelpie_core::Runtime;` to all test modules for trait method access
- Updated all 10 test functions to use `TokioRuntime` pattern

**Test Results:**
```
running 23 tests
test result: ok. 23 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

**Success Criteria:**
- [x] Dispatcher<A, S, R: Runtime> compiles ‚úÖ
- [x] All kelpie-runtime tests pass with TokioRuntime ‚úÖ (23/23 passing)
- [x] No direct tokio::spawn/sleep in kelpie-runtime ‚úÖ

### Phase 2.6.2: Update kelpie-server Production Code ‚è≥ PENDING

**Goal:** Thread Runtime through server code

**Changes:**
1. Update AgentService to accept Runtime
2. Update state.rs to use Runtime for background tasks
3. Update API handlers (agents, blocks, import_export) to use Runtime
4. Update http.rs NetworkDelay to use Runtime.sleep

**Files to modify:**
- `crates/kelpie-server/src/service.rs` (AgentService)
- `crates/kelpie-server/src/state.rs` (AppState, background tasks)
- `crates/kelpie-server/src/api/agents.rs` (agent API handlers)
- `crates/kelpie-server/src/api/blocks.rs` (block API handlers)
- `crates/kelpie-server/src/api/import_export.rs` (import/export handlers)
- `crates/kelpie-server/src/http.rs` (NetworkDelay fault injection)

**Success Criteria:**
- [ ] kelpie-server compiles with Runtime-aware code
- [ ] Production binary uses TokioRuntime
- [ ] No direct tokio::spawn/sleep in kelpie-server/src

### Phase 2.6.3: Add madsim to kelpie-server ‚è≥ PENDING

**Goal:** Enable madsim runtime for kelpie-server tests

**Changes:**
1. Add madsim to kelpie-server dev-dependencies
2. Add lints config for madsim cfg
3. Verify kelpie-server compiles with madsim available

**Files to modify:**
- `crates/kelpie-server/Cargo.toml`

**Success Criteria:**
- [ ] madsim in dev-dependencies
- [ ] No cfg warnings
- [ ] Tests still compile (even if not ported yet)

### Phase 2.6.4: Port Pilot Test ‚è≥ PENDING

**Goal:** Prove end-to-end Runtime integration works

**Target:** Pick smallest test file from kelpie-server/tests/

**Changes:**
1. Choose pilot test (prefer simple, no complex spawning)
2. Update test helper to create Dispatcher with MadsimRuntime
3. Change #[tokio::test] to #[madsim::test]
4. Verify test passes on madsim

**Success Criteria:**
- [ ] One kelpie-server test uses #[madsim::test]
- [ ] Test passes with MadsimRuntime
- [ ] Test completes in virtual time (0.00s)

### Phase 2.6.5: Expand Test Migration ‚è≥ PENDING

**Goal:** Migrate remaining kelpie-server tests

**Strategy:** Same as Phase 2.5 (kelpie-dst migration)

**Changes:**
1. Identify all 26 test files using #[tokio::test]
2. Convert tests one by one
3. Track progress (X/26 tests migrated)
4. Verify all tests pass with madsim

**Success Criteria:**
- [ ] All 26 kelpie-server test files migrated
- [ ] All tests passing with madsim
- [ ] No direct tokio usage in tests

### Phase 2.6.6: Production Verification ‚è≥ PENDING

**Goal:** Verify production still works with TokioRuntime

**Changes:**
1. Run full test suite (both tokio and madsim tests)
2. Build kelpie-server binary
3. Run integration smoke tests
4. Verify no performance regression

**Success Criteria:**
- [ ] All tests pass (both runtime flavors)
- [ ] Binary builds successfully
- [ ] Server starts and handles requests
- [ ] No observable performance impact

## Breaking Changes

### API Changes

**Dispatcher::new()**
```rust
// Before
Dispatcher::<MyActor, MyState>::new(factory, kv, config)

// After
Dispatcher::<MyActor, MyState, TokioRuntime>::new(factory, kv, config, TokioRuntime)
```

**DispatcherHandle**
```rust
// Before
let handle: DispatcherHandle<MyActor, MyState> = dispatcher.handle();

// After
let handle: DispatcherHandle<MyActor, MyState, TokioRuntime> = dispatcher.handle();
```

### Migration Guide for Users

For production code (continues to use tokio):
```rust
use kelpie_core::{Runtime, TokioRuntime};
use kelpie_runtime::Dispatcher;

let runtime = TokioRuntime;
let dispatcher = Dispatcher::<MyActor, MyState, _>::new(
    factory,
    kv,
    config,
    runtime
);
```

For DST tests (uses madsim):
```rust
use kelpie_core::{Runtime, MadsimRuntime};
use kelpie_runtime::Dispatcher;

#[madsim::test]
async fn my_test() {
    let runtime = MadsimRuntime;
    let dispatcher = Dispatcher::<MyActor, MyState, _>::new(
        factory,
        kv,
        config,
        runtime
    );
}
```

## Verification Checklist

- [x] kelpie-runtime refactored to use Runtime parameter ‚úÖ (Phase 2.6.1)
- [ ] kelpie-server production code uses Runtime (Phase 2.6.2)
- [ ] madsim added to kelpie-server dev-dependencies (Phase 2.6.3)
- [ ] Pilot test ported and passing (Phase 2.6.4)
- [ ] All 26 kelpie-server tests ported (Phase 2.6.5)
- [ ] Production binary still works with TokioRuntime (Phase 2.6.6)
- [x] No direct tokio::spawn/sleep in kelpie-runtime ‚úÖ
- [ ] No direct tokio::spawn/sleep in kelpie-server
- [ ] Documentation updated with migration examples

## Success Criteria

1. **Zero Direct Tokio Usage:** No tokio::spawn/sleep in kelpie-runtime or kelpie-server src
2. **Full Test Determinism:** All tests use madsim runtime
3. **Production Compatibility:** Server binary works unchanged with TokioRuntime
4. **Performance:** No observable regression
5. **Type Safety:** Runtime abstraction enforced at compile time

## Instance Log

| Instance | Phase | Status | Notes |
|----------|-------|--------|-------|
| Claude-1 | 2.6.1 | ‚úÖ COMPLETE | kelpie-runtime refactored, all 23 tests passing |
| Claude-2 | 2.6.2-2.6.6 | TODO | Ready to start kelpie-server integration |

## References

- Parent Plan: `.progress/024_20260119_dst_phase2_runtime_determinism.md`
- Runtime Trait: `crates/kelpie-core/src/runtime.rs`
- Dispatcher: `crates/kelpie-runtime/src/dispatcher.rs`
- Handle: `crates/kelpie-runtime/src/handle.rs`
