#!/bin/sh
#
# Kelpie VM Init System
#
# Minimal init for VM sandboxes. Mounts filesystems, starts guest agent.
# TigerStyle: Explicit error handling, no silent failures.

set -e

# Constants
readonly AGENT_BINARY="/usr/local/bin/kelpie-guest"
readonly AGENT_SOCKET="/tmp/kelpie-guest.sock"
readonly LOG_FILE="/var/log/kelpie-init.log"

# Logging helper
log() {
    echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] $*" | tee -a "$LOG_FILE"
}

log "Kelpie VM Init starting..."

# Mount essential filesystems
log "Mounting essential filesystems..."
mount -t proc proc /proc 2>/dev/null || log "Warning: /proc already mounted"
mount -t sysfs sys /sys 2>/dev/null || log "Warning: /sys already mounted"
mount -t devtmpfs dev /dev 2>/dev/null || log "Warning: /dev already mounted"
mount -t tmpfs tmpfs /tmp 2>/dev/null || log "Warning: /tmp already mounted"
mount -t tmpfs tmpfs /run 2>/dev/null || log "Warning: /run already mounted"

# Create device nodes if missing
if [ ! -c /dev/null ]; then
    log "Creating /dev/null"
    mknod -m 666 /dev/null c 1 3
fi

if [ ! -c /dev/zero ]; then
    log "Creating /dev/zero"
    mknod -m 666 /dev/zero c 1 5
fi

# Set hostname
if [ -f /etc/hostname ]; then
    HOSTNAME=$(cat /etc/hostname)
    hostname "$HOSTNAME" 2>/dev/null || log "Warning: Failed to set hostname"
    log "Hostname set to: $HOSTNAME"
else
    hostname kelpie-sandbox
    log "Hostname set to: kelpie-sandbox (default)"
fi

# Configure networking (loopback)
log "Configuring loopback interface..."
ip link set lo up 2>/dev/null || log "Warning: Failed to bring up loopback"

# Start guest agent if available
if [ -x "$AGENT_BINARY" ]; then
    log "Starting guest agent: $AGENT_BINARY"

    # Remove old socket if exists
    rm -f "$AGENT_SOCKET"

    # Start agent in background
    # Note: In production, we'd use virtio-vsock, but for development/testing we use Unix socket
    RUST_LOG=info KELPIE_GUEST_SOCKET="$AGENT_SOCKET" "$AGENT_BINARY" > /var/log/kelpie-guest.log 2>&1 &
    AGENT_PID=$!

    log "Guest agent started with PID: $AGENT_PID"

    # Wait briefly for agent to bind socket
    sleep 1

    if [ -S "$AGENT_SOCKET" ]; then
        log "Guest agent socket ready: $AGENT_SOCKET"
    else
        log "Warning: Guest agent socket not found (may still be starting)"
    fi
else
    log "Warning: Guest agent not found at $AGENT_BINARY"
fi

# Signal readiness
log "Init complete. System ready."

# Handle shutdown signals
shutdown_handler() {
    log "Shutdown signal received"

    # Stop guest agent gracefully
    if [ -n "$AGENT_PID" ]; then
        log "Stopping guest agent (PID: $AGENT_PID)"
        kill -TERM "$AGENT_PID" 2>/dev/null || true
        wait "$AGENT_PID" 2>/dev/null || true
    fi

    # Unmount filesystems
    log "Unmounting filesystems..."
    sync
    umount -a -r 2>/dev/null || true

    log "Shutdown complete"
    exit 0
}

trap shutdown_handler TERM INT QUIT

# Keep init running (PID 1 must never exit)
# In a real scenario, we'd wait for commands from host
if [ -n "$AGENT_PID" ]; then
    log "Waiting for guest agent (PID: $AGENT_PID)..."
    wait "$AGENT_PID"
    log "Guest agent exited"
else
    log "No guest agent running. Entering idle loop..."
    while true; do
        sleep 3600  # Sleep for 1 hour
    done
fi
