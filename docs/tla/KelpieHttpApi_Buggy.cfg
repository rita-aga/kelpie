\* TLC Configuration for KelpieHttpApi - Buggy Version
\*
\* This configuration demonstrates what happens WITHOUT idempotency.
\* Run with: java -XX:+UseParallelGC -jar tla2tools.jar -deadlock -config KelpieHttpApi_Buggy.cfg KelpieHttpApi.tla
\*
\* Expected: Model checker should find invariant violations because:
\* 1. Without idempotency tokens, retries can cause duplicate creation attempts
\* 2. Concurrent requests without tokens can lead to inconsistent state
\*
\* This is a negative test to demonstrate the importance of idempotency.

\* =========================================================================
\* SPECIFICATION
\* =========================================================================

\* Use safety-only spec (no liveness checking)
SPECIFICATION SafetySpec

\* =========================================================================
\* CONSTANTS
\* =========================================================================

\* Minimal model to demonstrate bugs
CONSTANT
    HttpClients = {c1, c2}
    Agents = {a1}
    IdempotencyTokens = {t1}
    NONE = NONE
    MAX_OPERATIONS = 8

\* =========================================================================
\* STATE CONSTRAINT (for bounded model checking)
\* =========================================================================

CONSTRAINT StateConstraint

\* =========================================================================
\* INVARIANTS (Safety Properties)
\* =========================================================================

\* Only check type invariant - other invariants should fail without
\* proper idempotency token usage (when clients don't use tokens)
INVARIANT TypeOK

\* These invariants are expected to hold even without tokens:
INVARIANT AtomicOperation

\* Note: To see failures, run scenarios where clients send requests
\* without idempotency tokens (t = NONE). The spec allows this, and
\* ExactlyOnceExecution violations can occur when:
\* 1. Client sends CreateAgent without token
\* 2. Server processes and creates agent
\* 3. Response is lost (not modeled directly, but retry without token is allowed)
\* 4. Client retries with DIFFERENT token or no token
\* 5. Now state is inconsistent
\*
\* To properly demonstrate bugs, you would need to:
\* 1. Add explicit response loss modeling
\* 2. Or check IdempotencyGuarantee which will fail for NONE tokens
