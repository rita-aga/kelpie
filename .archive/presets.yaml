# Pre-built Spec Configurations
#
# Phase 10.6: Ready-to-use spec configurations for common questions.
#
# Usage: Pass preset name to codebase_question tool:
#   codebase_question(question="...", specs=["dst_assessment"])
#
# TigerStyle: Explicit configurations, no hidden defaults.

version: "1.0"

presets:
  # DST Assessment - comprehensive DST coverage check
  dst_assessment:
    description: "Assess DST state: coverage, fakes, harness quality"
    specs:
      - type: pattern_rules
        source: dst-coverage.yaml
    checks:
      - coverage_completeness      # All critical paths have DST tests
      - determinism_verification   # Tests are actually deterministic
      - fault_injection_adequacy   # Required faults are injected
      - harness_completeness       # Harnesses model real behavior
    scope_patterns:
      - "crates/kelpie-dst/**"
      - "crates/kelpie-storage/**"
      - "crates/kelpie-runtime/**"
      - "crates/kelpie-server/tests/*_dst.rs"

  # Letta Compatibility - API conformance check
  letta_compatibility:
    description: "Check Letta API compatibility: endpoints, schemas, behaviors"
    specs:
      - type: openapi
        source: letta-openapi.yaml  # Reference to Letta's OpenAPI spec
    checks:
      - endpoint_implementation    # All endpoints implemented
      - schema_conformance         # Request/response schemas match
      - behavior_parity            # Behaviors match spec descriptions
      - error_handling             # Error codes match spec
    scope_patterns:
      - "crates/kelpie-server/src/api/**"
      - "crates/kelpie-server/src/models/**"

  # TigerStyle Compliance - engineering standards check
  tigerstyle_compliance:
    description: "Check TigerStyle engineering principles compliance"
    specs:
      - type: pattern_rules
        source: tigerstyle-rules.yaml
    checks:
      - assertions_per_function    # 2+ assertions per non-trivial function
      - explicit_error_handling    # No silent error swallowing
      - bounded_iteration          # No unbounded loops/recursion
      - explicit_units             # Constants have unit suffixes
    scope_patterns:
      - "crates/**/*.rs"

  # Storage Layer Health - storage subsystem check
  storage_health:
    description: "Assess storage layer: FDB integration, error handling, DST coverage"
    specs:
      - type: pattern_rules
        source: dst-coverage.yaml
    checks:
      - fdb_transaction_safety     # Transactions properly handled
      - error_propagation          # Errors not silently swallowed
      - dst_coverage               # Storage ops have DST tests
    scope_patterns:
      - "crates/kelpie-storage/**"
      - "crates/kelpie-server/src/storage/**"

  # Actor Runtime Health - actor lifecycle check
  actor_health:
    description: "Assess actor runtime: lifecycle, crash recovery, message handling"
    specs:
      - type: pattern_rules
        source: dst-coverage.yaml
    checks:
      - activation_deactivation    # Proper lifecycle
      - crash_recovery             # Recovery from crashes
      - message_delivery           # At-least-once delivery
      - state_persistence          # State properly persisted
    scope_patterns:
      - "crates/kelpie-runtime/**"
      - "crates/kelpie-server/src/actor/**"

  # Full Codebase Audit - comprehensive check
  full_audit:
    description: "Full codebase audit: DST, API, TigerStyle, storage, actors"
    specs:
      - type: pattern_rules
        source: dst-coverage.yaml
      - type: pattern_rules
        source: tigerstyle-rules.yaml
    checks:
      - dst_coverage
      - tigerstyle_compliance
      - storage_health
      - actor_health
      - api_implementation
    scope_patterns:
      - "crates/**"

# Quick references for common questions
question_mappings:
  "DST":
    preset: dst_assessment
    example_questions:
      - "What's the state of DST coverage?"
      - "Are all DST tests actually deterministic?"
      - "What critical paths are missing DST tests?"

  "Letta":
    preset: letta_compatibility
    example_questions:
      - "Is Letta API compatibility complete?"
      - "What Letta endpoints are missing?"
      - "Do response schemas match the Letta spec?"

  "TigerStyle":
    preset: tigerstyle_compliance
    example_questions:
      - "Are we following TigerStyle principles?"
      - "Where are we missing assertions?"
      - "Are there any unbounded loops?"

  "Storage":
    preset: storage_health
    example_questions:
      - "Is the storage layer healthy?"
      - "Are FDB transactions properly handled?"
      - "What storage operations lack DST coverage?"

  "Actors":
    preset: actor_health
    example_questions:
      - "Is the actor runtime healthy?"
      - "Is crash recovery properly tested?"
      - "Are there any message delivery issues?"
