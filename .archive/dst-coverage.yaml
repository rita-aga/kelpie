# DST Coverage Requirements
# 
# Defines what code paths must have DST tests and what faults must be injected.
# Used by the Codebase Intelligence Layer to verify DST completeness.
#
# TigerStyle: Explicit requirements, verifiable claims.

source: dst_rules
version: "1.0"

rules:
  # Storage layer DST requirements
  - id: storage_dst_coverage
    description: "All pub async fn in storage layer must have DST test"
    file_pattern: "crates/kelpie-storage/**/*.rs"
    function_pattern: "pub async fn"
    required:
      test_file_suffix: "_dst.rs"
      fault_injection:
        - StorageWriteFail
        - StorageReadFail
        - StorageTimeout

  - id: fdb_transaction_dst
    description: "FDB transactions must be tested with commit/abort faults"
    file_pattern: "crates/kelpie-storage/src/fdb.rs"
    function_pattern: "transaction|commit|abort"
    required:
      test_file_suffix: "_dst.rs"
      fault_injection:
        - TransactionCommitFail
        - TransactionAbort
        - DeadlockDetected

  # Actor lifecycle DST requirements
  - id: actor_crash_recovery
    description: "Actor recovery must have DST with crash faults"
    file_pattern: "crates/kelpie-runtime/src/**/*.rs"
    function_pattern: "recover|restore|activate|deactivate"
    required:
      fault_injection:
        - CrashBeforeWrite
        - CrashAfterWrite
        - CrashDuringStateRestore
      determinism: true

  - id: actor_message_handling
    description: "Actor message handling must be DST tested"
    file_pattern: "crates/kelpie-runtime/src/activation.rs"
    function_pattern: "invoke|dispatch|handle"
    required:
      test_file_suffix: "_dst.rs"
      fault_injection:
        - MessageTimeout
        - MailboxFull
      determinism: true

  # Teleport (VM migration) DST requirements
  - id: teleport_snapshot
    description: "Teleport snapshot/restore must be DST tested"
    file_pattern: "crates/kelpie-server/src/service/teleport_service.rs"
    function_pattern: "teleport_out|teleport_in|snapshot|restore"
    required:
      fault_injection:
        - SnapshotCorrupted
        - RestoreFailed
        - NetworkPartition
      determinism: true

  # Cluster coordination DST requirements
  - id: cluster_membership
    description: "Cluster membership changes must be DST tested"
    file_pattern: "crates/kelpie-cluster/**/*.rs"
    function_pattern: "join|leave|heartbeat|failover"
    required:
      fault_injection:
        - NodeCrash
        - NetworkPartition
        - HeartbeatTimeout
      determinism: true

  # Agent service DST requirements
  - id: agent_message_loop
    description: "Agent message processing loop must be DST tested"
    file_pattern: "crates/kelpie-server/src/actor/agent_actor.rs"
    function_pattern: "process_message|send_message|step"
    required:
      test_file_suffix: "_dst.rs"
      fault_injection:
        - LLMTimeout
        - ToolExecutionFail
        - StateCorruption
      determinism: true

  # Memory tools DST requirements
  - id: memory_tools_dst
    description: "Memory tools must be DST tested with concurrent access"
    file_pattern: "crates/kelpie-server/src/tools/memory.rs"
    function_pattern: "core_memory|archival|recall"
    required:
      test_file_suffix: "_dst.rs"
      fault_injection:
        - ConcurrentWrite
        - MemoryLimitExceeded
      determinism: true
