# TigerStyle Engineering Principles Rules
#
# Based on TigerBeetle's engineering principles:
# https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/TIGER_STYLE.md
#
# TigerStyle: Safety > Performance > DX

source: tigerstyle_rules
version: "1.0"

rules:
  # Assertions
  - id: assertions_per_function
    description: "Non-trivial functions should have 2+ assertions (preconditions/postconditions)"
    file_pattern: "crates/**/*.rs"
    function_pattern: "pub fn|pub async fn"
    required:
      min_assertions: 2
      assertion_patterns:
        - "assert!"
        - "assert_eq!"
        - "assert_ne!"
        - "debug_assert!"
    exceptions:
      - "trivial getters/setters"
      - "simple constructors"
      - "test functions"

  # Error Handling
  - id: no_silent_errors
    description: "Errors must not be silently ignored - no bare .ok() without logging"
    file_pattern: "crates/**/*.rs"
    anti_patterns:
      - "\\.ok\\(\\)\\s*;"           # .ok(); with no use
      - "\\.ok\\(\\)\\s*\\}"         # .ok() at end of block
      - "let _ = .*\\.ok\\(\\)"      # let _ = x.ok()
    required:
      error_handling: "Result propagation or explicit logging"

  # Panics
  - id: no_production_panics
    description: "No .unwrap() or .expect() in production code - use Result<T, E>"
    file_pattern: "crates/**/src/**/*.rs"
    anti_patterns:
      - "\\.unwrap\\(\\)"
      - "\\.expect\\("
    exceptions:
      - "test code"
      - "builder patterns with infallible build()"
      - "compile-time constants (regex, etc.)"
    required:
      error_handling: "? operator or explicit match"

  # Explicit Units
  - id: explicit_units
    description: "Constants must have explicit units in names (e.g., TIMEOUT_MS not TIMEOUT)"
    file_pattern: "crates/**/*.rs"
    pattern: "const.*:"
    required:
      naming_convention: "UNIT_SUFFIX"
      valid_suffixes:
        - "_MS"      # milliseconds
        - "_S"       # seconds
        - "_BYTES"   # bytes
        - "_KB"      # kilobytes
        - "_MB"      # megabytes
        - "_COUNT"   # count
        - "_MAX"     # maximum
        - "_MIN"     # minimum
        - "_DEFAULT" # default value

  # Bounded Iteration
  - id: bounded_iteration
    description: "Loops must be bounded - no infinite loops without explicit break conditions"
    file_pattern: "crates/**/*.rs"
    anti_patterns:
      - "loop\\s*\\{"           # bare loop {} without clear exit
      - "while\\s+true"         # while true
    required:
      iteration: "for loop with bounded iterator or loop with explicit break condition"

  # No Recursion
  - id: no_recursion
    description: "Avoid recursion - use bounded iteration instead"
    file_pattern: "crates/**/*.rs"
    check_type: "call_graph"
    required:
      recursive_calls: 0
    exceptions:
      - "tree traversal with depth limit"
      - "parsing with explicit depth check"

  # Explicit Lifetimes
  - id: explicit_lifetimes
    description: "Prefer explicit lifetimes over elision in public APIs"
    file_pattern: "crates/**/*.rs"
    pattern: "pub fn.*&"
    required:
      lifetime_annotation: "explicit where non-trivial"

  # No Magic Numbers
  - id: no_magic_numbers
    description: "Avoid magic numbers - use named constants"
    file_pattern: "crates/**/*.rs"
    anti_patterns:
      - "\\b[0-9]{4,}\\b"  # Large numeric literals
    exceptions:
      - "array indices 0, 1"
      - "port numbers in tests"
      - "version numbers"
    required:
      numeric_literals: "named constants for values > 10"

  # Documentation
  - id: public_api_docs
    description: "All public items must have documentation"
    file_pattern: "crates/**/*.rs"
    pattern: "pub (fn|struct|enum|trait|type|const)"
    required:
      documentation: "/// doc comment"
    exceptions:
      - "impl blocks"
      - "re-exports"

  # Safety Comments
  - id: unsafe_safety_comments
    description: "All unsafe blocks must have SAFETY comments"
    file_pattern: "crates/**/*.rs"
    pattern: "unsafe"
    required:
      comment: "// SAFETY: explanation"

# Severity mappings
severity_mapping:
  no_production_panics: high
  no_silent_errors: high
  assertions_per_function: medium
  explicit_units: medium
  bounded_iteration: high
  no_recursion: medium
  no_magic_numbers: low
  public_api_docs: low
  unsafe_safety_comments: critical
