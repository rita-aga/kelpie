name: Letta Compatibility

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sundays

jobs:
  test-compatibility:
    name: SDK Compatibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Setup Rust
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      
      # Build Kelpie Server
      - name: Build Kelpie Server
        run: cargo build --release -p kelpie-server

      # Setup Python
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # Install Letta SDK and dependencies
      - name: Install Letta SDK
        run: |
          pip install letta pytest
          # We'll install the package in editable mode from the clone below for tests
      
      # Run Server & Tests
      - name: Run Compatibility Tests
        env:
          ANTHROPIC_API_KEY: "sk-dummy-key"
        run: |
          # Start server in background
          ./target/release/kelpie-server > kelpie.log 2>&1 &
          SERVER_PID=$!
          
          # Wait for health check
          echo "Waiting for Kelpie server..."
          timeout 30s bash -c 'until curl -s http://localhost:8283/health > /dev/null; do sleep 1; done' || (cat kelpie.log && exit 1)
          
          # Clone Letta repo to access its test suite
          git clone https://github.com/letta-ai/letta.git letta-repo
          
          export LETTA_SERVER_URL=http://localhost:8283
          
          cd letta-repo
          # Install test dependencies
          pip install -e ".[dev]"
          
          # Run the specific tests we know pass/are relevant
          # Exclude search (needs external service), groups/identities (not implemented)
          pytest tests/sdk/agents_test.py tests/sdk/blocks_test.py tests/sdk/tools_test.py tests/sdk/mcp_servers_test.py -v
          
          # Cleanup
          kill $SERVER_PID
