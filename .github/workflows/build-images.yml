name: Build Base Images

on:
  push:
    branches: [master, main]
    paths:
      - 'images/**'
      - '.github/workflows/build-images.yml'
  pull_request:
    paths:
      - 'images/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (SemVer format)'
        required: false
        default: 'dev'
      push_to_registry:
        description: 'Push to GitHub Container Registry'
        required: false
        default: 'false'

env:
  ALPINE_VERSION: '3.19'

jobs:
  build-multi-arch:
    name: Build ${{ matrix.arch }} image
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: ubuntu-latest-arm64
          - arch: amd64
            runner: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name == 'release' || github.event.inputs.push_to_registry == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build base image
        working-directory: images
        run: |
          ./build.sh \
            --arch ${{ matrix.arch }} \
            --version ${{ steps.version.outputs.VERSION }}

      - name: Test image
        run: |
          # Basic smoke tests
          docker run --rm kelpie-base:latest cat /etc/kelpie-version
          docker run --rm kelpie-base:latest cat /sbin/init | head -5
          docker run --rm kelpie-base:latest sh -c 'command -v bash && command -v sh'

      - name: Extract kernel
        if: github.event_name == 'release' || github.event.inputs.push_to_registry == 'true'
        working-directory: images/kernel
        run: |
          ./extract-kernel.sh
          ls -lh vmlinuz-* initramfs-* kernel-metadata.json

      - name: Package image artifacts
        if: github.event_name == 'release' || github.event.inputs.push_to_registry == 'true'
        run: |
          mkdir -p artifacts

          # Export Docker image
          docker save kelpie-base:latest | gzip > artifacts/kelpie-base-${{ steps.version.outputs.VERSION }}-${{ matrix.arch }}.tar.gz

          # Copy kernel and initrd
          cp images/kernel/vmlinuz-${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }} artifacts/ || true
          cp images/kernel/initramfs-${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }} artifacts/ || true
          cp images/kernel/kernel-metadata.json artifacts/kernel-metadata-${{ matrix.arch }}.json || true

          # Create checksums
          cd artifacts
          sha256sum * > SHA256SUMS
          cd ..

          ls -lh artifacts/

      - name: Upload artifacts
        if: github.event_name == 'release' || github.event.inputs.push_to_registry == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: kelpie-base-${{ matrix.arch }}
          path: artifacts/
          retention-days: 30

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to registry
        if: github.event_name == 'release' || github.event.inputs.push_to_registry == 'true'
        working-directory: images
        run: |
          # Tag and push to GitHub Container Registry
          REGISTRY="ghcr.io/${{ github.repository_owner }}/kelpie-base"
          VERSION="${{ steps.version.outputs.VERSION }}"

          docker tag kelpie-base:latest "$REGISTRY:$VERSION-${{ matrix.arch }}"
          docker tag kelpie-base:latest "$REGISTRY:latest-${{ matrix.arch }}"

          docker push "$REGISTRY:$VERSION-${{ matrix.arch }}"
          docker push "$REGISTRY:latest-${{ matrix.arch }}"

  create-manifest:
    name: Create multi-arch manifest
    runs-on: ubuntu-latest
    needs: build-multi-arch
    if: github.event_name == 'release' || github.event.inputs.push_to_registry == 'true'

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create and push manifest
        run: |
          REGISTRY="ghcr.io/${{ github.repository_owner }}/kelpie-base"
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Create version manifest
          docker manifest create "$REGISTRY:$VERSION" \
            "$REGISTRY:$VERSION-arm64" \
            "$REGISTRY:$VERSION-amd64"

          docker manifest push "$REGISTRY:$VERSION"

          # Create latest manifest
          docker manifest create "$REGISTRY:latest" \
            "$REGISTRY:latest-arm64" \
            "$REGISTRY:latest-amd64"

          docker manifest push "$REGISTRY:latest"

          echo "Multi-arch manifest created and pushed:"
          echo "  $REGISTRY:$VERSION"
          echo "  $REGISTRY:latest"
